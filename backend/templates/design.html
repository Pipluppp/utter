{% extends "base.html" %}

{% block title %}Design Voice - Utter{% endblock %}

{% block content %}
<h1 class="title-page">Design a New Voice</h1>
<p class="subtitle">Create a custom voice by describing how you want it to sound. No audio upload needed.</p>

<details class="page-guide">
    <summary>
        <span>ℹ️ Tips for Best Results</span>
        <span class="page-guide-chevron">▼</span>
    </summary>
    <div class="page-guide-content">
        <ul>
            <li><strong>Description:</strong> Be specific about tone, gender, age, and accent</li>
            <li><strong>Preview text:</strong> Keep it short (under 500 chars) for faster previews</li>
            <li><strong>Processing time:</strong> 15–45 seconds per preview</li>
            <li><strong>Saving:</strong> The preview audio becomes the reference for long-form generation</li>
        </ul>
        <p><strong>Good example:</strong> "A warm, friendly female voice with a gentle British accent"</p>
    </div>
</details>

<form id="design-form">
    <div id="error-container" class="message hidden"></div>
    <div id="success-container" class="message message-success hidden"></div>

    <div class="form-group">
        <label class="input-label" for="voice-name">Voice Name</label>
        <input type="text" class="input" id="voice-name" name="name" placeholder="My Custom Voice" maxlength="100"
            required>
    </div>

    <div class="form-group">
        <label class="input-label" for="voice-description">Voice Description</label>
        <textarea class="textarea" id="voice-description" name="instruct"
            placeholder="Describe the voice you want to create. For example:&#10;&#10;• A warm, friendly female voice with a gentle, reassuring tone&#10;• A deep, authoritative male voice like a news anchor&#10;• A cheerful, energetic young voice with enthusiasm"
            style="min-height: 120px;" required></textarea>
        <div class="char-counter" id="description-counter">0 / 500 chars</div>
    </div>

    <div class="form-group">
        <label class="input-label" for="preview-text">Preview Text</label>
        <textarea class="textarea" id="preview-text" name="text"
            placeholder="Enter the text you want the voice to speak in the preview. This will also be saved as the voice's reference transcript."
            style="min-height: 80px;"
            required>Hello! I'm so glad you're here. Let me help you with anything you need today.</textarea>
        <div class="char-counter" id="preview-counter">0 / 500 chars</div>
    </div>

    <div class="form-group">
        <label class="input-label" for="language-select">Language</label>
        <select class="select" id="language-select" name="language">
            <option value="English" selected>English</option>
            <option value="Chinese">Chinese</option>
            <option value="Japanese">Japanese</option>
            <option value="Korean">Korean</option>
            <option value="German">German</option>
            <option value="French">French</option>
            <option value="Russian">Russian</option>
            <option value="Portuguese">Portuguese</option>
            <option value="Spanish">Spanish</option>
            <option value="Italian">Italian</option>
        </select>
    </div>

    <!-- Preview Section -->
    <div class="result-section" id="preview-section" style="display: none;">
        <div class="divider"></div>
        <label class="text-label">Voice Preview</label>
        <div class="audio-player">
            <button type="button" class="audio-player-btn" id="preview-play-btn" disabled>
                <span class="play-icon">▶</span>
            </button>
            <div id="preview-waveform" class="audio-player-waveform"></div>
            <div class="audio-player-time" id="preview-time">0:00 / 0:00</div>
        </div>
    </div>

    <div class="button-group">
        <button type="button" class="btn btn-secondary" id="generate-preview-btn">
            Generate Preview
        </button>
        <button type="submit" class="btn" id="save-voice-btn" disabled>
            Save Voice
        </button>
    </div>
</form>

<!-- Generation Progress (shown during generation) -->
<div class="generation-progress hidden" id="design-progress">
    <div class="progress-spinner"></div>
    <div class="progress-info">
        <div class="progress-title">Designing voice...</div>
        <div class="progress-time">
            <span class="progress-elapsed" id="design-elapsed">0:00</span>
            <span class="progress-elapsed-label">elapsed</span>
        </div>
        <div class="progress-hint">Voice design typically takes 15–45 seconds</div>
    </div>
</div>

<!-- Example Prompts -->
<div class="examples-section">
    <h3>Example Voice Descriptions</h3>
    <div class="example-cards">
        <div class="example-card"
            data-instruct="A warm, friendly female voice with a gentle, reassuring tone. Natural and conversational.">
            <strong>Friendly Female</strong>
            <p>Warm, gentle, reassuring</p>
        </div>
        <div class="example-card"
            data-instruct="A deep, authoritative male voice like a professional news anchor. Clear, confident, and commanding.">
            <strong>News Anchor</strong>
            <p>Deep, authoritative, clear</p>
        </div>
        <div class="example-card"
            data-instruct="A cheerful, energetic young voice with enthusiasm. Upbeat and engaging, like a content creator.">
            <strong>Energetic YouTuber</strong>
            <p>Cheerful, upbeat, engaging</p>
        </div>
        <div class="example-card"
            data-instruct="A calm, soothing voice perfect for meditation and relaxation. Slow, peaceful, and tranquil.">
            <strong>Meditation Guide</strong>
            <p>Calm, soothing, peaceful</p>
        </div>
        <div class="example-card"
            data-instruct="A refined British male voice with gravitas, like a documentary narrator. Measured pace, rich tone.">
            <strong>British Narrator</strong>
            <p>Refined, gravitas, rich</p>
        </div>
        <div class="example-card"
            data-instruct="An elderly, wise-sounding voice with warmth and experience. Thoughtful and measured delivery.">
            <strong>Wise Elder</strong>
            <p>Elderly, warm, thoughtful</p>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('design-form');
        const nameInput = document.getElementById('voice-name');
        const descriptionInput = document.getElementById('voice-description');
        const previewTextInput = document.getElementById('preview-text');
        const languageSelect = document.getElementById('language-select');
        const generatePreviewBtn = document.getElementById('generate-preview-btn');
        const saveVoiceBtn = document.getElementById('save-voice-btn');
        const previewSection = document.getElementById('preview-section');
        const errorContainer = document.getElementById('error-container');
        const successContainer = document.getElementById('success-container');
        const descriptionCounter = document.getElementById('description-counter');
        const previewCounter = document.getElementById('preview-counter');

        let previewWavesurfer = null;
        let previewAudioBlob = null;

        // Character counters
        function updateCounter(input, counter, max) {
            const len = input.value.length;
            counter.textContent = `${len} / ${max} chars`;
            counter.style.color = len > max ? '#ef4444' : '#888';
        }

        descriptionInput.addEventListener('input', () => updateCounter(descriptionInput, descriptionCounter, 500));
        previewTextInput.addEventListener('input', () => updateCounter(previewTextInput, previewCounter, 500));

        // Initialize counters
        updateCounter(descriptionInput, descriptionCounter, 500);
        updateCounter(previewTextInput, previewCounter, 500);

        // Example card click handlers
        document.querySelectorAll('.example-card').forEach(card => {
            card.addEventListener('click', () => {
                descriptionInput.value = card.dataset.instruct;
                updateCounter(descriptionInput, descriptionCounter, 500);
                descriptionInput.focus();
            });
        });

        // Show error
        function showError(message) {
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
            successContainer.classList.add('hidden');
        }

        // Show success
        function showSuccess(message) {
            successContainer.textContent = message;
            successContainer.classList.remove('hidden');
            errorContainer.classList.add('hidden');
        }

        // Hide messages
        function hideMessages() {
            errorContainer.classList.add('hidden');
            successContainer.classList.add('hidden');
        }

        // Helper to display preview audio from base64 or blob
        function displayPreviewAudio(audioBlob) {
            previewAudioBlob = audioBlob;
            const audioUrl = URL.createObjectURL(previewAudioBlob);

            // Show preview section
            previewSection.style.display = 'block';

            // Initialize or update wavesurfer
            if (previewWavesurfer) {
                previewWavesurfer.destroy();
            }

            previewWavesurfer = WaveSurfer.create({
                container: '#preview-waveform',
                waveColor: '#a0a0a0',
                progressColor: '#111111',
                cursorColor: 'transparent',
                barWidth: 2,
                barGap: 2,
                barRadius: 0,
                height: 48,
                normalize: true,
            });

            previewWavesurfer.load(audioUrl);

            const playBtn = document.getElementById('preview-play-btn');
            const timeDisplay = document.getElementById('preview-time');

            previewWavesurfer.on('ready', () => {
                playBtn.disabled = false;
                const duration = previewWavesurfer.getDuration();
                timeDisplay.textContent = `0:00 / ${formatTime(duration)}`;
            });

            previewWavesurfer.on('audioprocess', () => {
                const current = previewWavesurfer.getCurrentTime();
                const duration = previewWavesurfer.getDuration();
                timeDisplay.textContent = `${formatTime(current)} / ${formatTime(duration)}`;
            });

            previewWavesurfer.on('play', () => {
                playBtn.querySelector('.play-icon').textContent = '⏸';
            });

            previewWavesurfer.on('pause', () => {
                playBtn.querySelector('.play-icon').textContent = '▶';
            });

            // Remove existing listener to avoid duplicates
            const newPlayBtn = playBtn.cloneNode(true);
            playBtn.parentNode.replaceChild(newPlayBtn, playBtn);
            newPlayBtn.addEventListener('click', () => {
                previewWavesurfer.playPause();
            });

            // Enable save button
            saveVoiceBtn.disabled = false;
        }

        // Reset UI to default state
        function resetGenerateUI() {
            if (window._designTimerInterval) {
                clearInterval(window._designTimerInterval);
                window._designTimerInterval = null;
            }

            // Hide progress section
            const progressSection = document.getElementById('design-progress');
            if (progressSection) {
                progressSection.classList.add('hidden');
            }

            generatePreviewBtn.disabled = false;
            generatePreviewBtn.classList.remove('btn-loading');
            generatePreviewBtn.textContent = 'Generate Preview';
        }

        // Generate Preview - using async task system
        generatePreviewBtn.addEventListener('click', async () => {
            hideMessages();

            const text = previewTextInput.value.trim();
            const instruct = descriptionInput.value.trim();
            const language = languageSelect.value;

            if (!instruct) {
                showError('Please enter a voice description');
                return;
            }
            if (!text) {
                showError('Please enter preview text');
                return;
            }

            generatePreviewBtn.disabled = true;
            generatePreviewBtn.classList.add('btn-loading');

            // Show progress section
            const progressSection = document.getElementById('design-progress');
            const progressElapsed = document.getElementById('design-elapsed');
            if (progressSection) {
                progressSection.classList.remove('hidden');
            }

            // Track elapsed time
            const startTime = Date.now();
            const updateTimer = () => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;
                generatePreviewBtn.textContent = `Generating... ${timeStr}`;
                if (progressElapsed) {
                    progressElapsed.textContent = timeStr;
                }
            };
            updateTimer();
            window._designTimerInterval = setInterval(updateTimer, 1000);

            try {
                // Start the async task
                const response = await fetch('/api/voices/design/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, language, instruct })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to start preview generation');
                }

                // Start task tracking with backend task ID
                if (window.taskManager && data.task_id) {
                    const formState = {
                        voiceName: nameInput.value,
                        instruct,
                        text,
                        language
                    };
                    window.taskManager.startTask(
                        data.task_id,
                        'design',
                        '/design',
                        'Generating voice preview...',
                        formState
                    );
                }

                // Task manager will poll and dispatch 'taskComplete' event

            } catch (error) {
                resetGenerateUI();
                showError(error.message);
            }
        });

        // Listen for task completion from TaskManager
        window.addEventListener('taskComplete', (e) => {
            const { type, status, result, error, storedTask } = e.detail;

            if (type && type !== 'design') {
                return;
            }
            if (storedTask && storedTask.originPage !== '/design') {
                return;
            }

            resetGenerateUI();

            if (status === 'completed' && result && result.audio_base64) {
                // Convert base64 to blob
                const byteCharacters = atob(result.audio_base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const audioBlob = new Blob([byteArray], { type: 'audio/wav' });

                displayPreviewAudio(audioBlob);
                showSuccess('Preview generated! Listen and save if you like it.');

            } else if (status === 'failed') {
                showError(error || 'Preview generation failed. Please try again.');
            }
        });

        // Check if returning to page with active task
        function checkAndRestoreActiveTask() {
            if (!window.taskManager) return;

            const task = window.taskManager.getTask('design');
            if (!task || task.originPage !== '/design') {
                return;
            }

            // Restore form state
            const formState = task.formState;
            if (formState) {
                if (formState.voiceName) nameInput.value = formState.voiceName;
                if (formState.instruct) {
                    descriptionInput.value = formState.instruct;
                    updateCounter(descriptionInput, descriptionCounter, 500);
                }
                if (formState.text) {
                    previewTextInput.value = formState.text;
                    updateCounter(previewTextInput, previewCounter, 500);
                }
                if (formState.language) languageSelect.value = formState.language;
            }

            // If task already completed, event will fire shortly
            if (task.status === 'completed' || task.status === 'failed' || task.status === 'cancelled') {
                generatePreviewBtn.disabled = true;
                generatePreviewBtn.textContent = 'Loading result...';
                return;
            }

            // Task still in progress - show loading state with progress section
            const progressSection = document.getElementById('design-progress');
            const progressElapsed = document.getElementById('design-elapsed');

            if (progressSection) {
                progressSection.classList.remove('hidden');
            }

            generatePreviewBtn.disabled = true;
            generatePreviewBtn.classList.add('btn-loading');

            // Start timer from original start time
            const startTime = task.startedAt;
            window._designTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;
                generatePreviewBtn.textContent = `Generating... ${timeStr}`;
                if (progressElapsed) {
                    progressElapsed.textContent = timeStr;
                }
            }, 1000);

            // Immediate update
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;
            generatePreviewBtn.textContent = `Generating... ${timeStr}`;
            if (progressElapsed) {
                progressElapsed.textContent = timeStr;
            }
        }

        // Initialize on page load
        checkAndRestoreActiveTask();

        // Save Voice
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();

            const name = nameInput.value.trim();
            const text = previewTextInput.value.trim();
            const instruct = descriptionInput.value.trim();
            const language = languageSelect.value;

            if (!name) {
                showError('Please enter a voice name');
                return;
            }
            if (!previewAudioBlob) {
                showError('Please generate a preview first');
                return;
            }

            saveVoiceBtn.disabled = true;
            saveVoiceBtn.classList.add('btn-loading');

            try {
                // Send the preview audio blob directly instead of regenerating
                const formData = new FormData();
                formData.append('name', name);
                formData.append('text', text);
                formData.append('language', language);
                formData.append('instruct', instruct);
                formData.append('audio', previewAudioBlob, 'preview.wav');

                const response = await fetch('/api/voices/design', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save voice');
                }

                const result = await response.json();
                showSuccess(`Voice "${result.name}" created! Redirecting to voices...`);

                // Redirect to voices page after a short delay
                setTimeout(() => {
                    window.location.href = '/voices';
                }, 1500);

            } catch (error) {
                showError(error.message);
                saveVoiceBtn.disabled = false;
                saveVoiceBtn.classList.remove('btn-loading');
            }
        });

        // Format time helper
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    });
</script>

<style>
    .subtitle {
        color: var(--text-muted);
        margin-bottom: var(--space-4);
        font-size: 14px;
    }

    .button-group {
        display: flex;
        gap: var(--space-2);
        margin-top: var(--space-3);
    }

    .button-group .btn {
        flex: 1;
    }

    .examples-section {
        margin-top: var(--space-6);
        padding-top: var(--space-4);
        border-top: 1px solid var(--border);
    }

    .examples-section h3 {
        color: var(--text-muted);
        font-size: 12px;
        margin-bottom: var(--space-2);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .example-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: var(--space-2);
    }

    .example-card {
        background: var(--bg-subtle);
        border: 1px solid var(--border);
        padding: var(--space-2);
        cursor: pointer;
        transition: all 0.15s;
    }

    .example-card:hover {
        border-color: var(--text);
        background: var(--bg-muted);
    }

    .example-card strong {
        display: block;
        margin-bottom: 4px;
        color: var(--text);
        font-size: 13px;
    }

    .example-card p {
        color: var(--text-muted);
        font-size: 12px;
        margin: 0;
    }
</style>
{% endblock %}
